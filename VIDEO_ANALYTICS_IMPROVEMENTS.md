# üé• –£–ª—É—á—à–µ–Ω–∏—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –í–∏–¥–µ–æ

## üîç **–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã):**

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 1: –ü—Ä–æ–ø—É—Å–∫ —Ç—Ä–µ–∫–∏–Ω–≥–∞**
- **–ß—Ç–æ –±—ã–ª–æ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∏–¥–µ–æ (—Å–∫—Ä–æ–ª–ª, –∫–Ω–æ–ø–∫–∞ X) –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- **–ì–¥–µ –±—ã–ª–æ**: `IntersectionObserver`, –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –í—Å–µ –º–µ—Å—Ç–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `safeCloseVideo()` —Å —Ç—Ä–µ–∫–∏–Ω–≥–æ–º

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ—Ç–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ YouTube**
- **–ß—Ç–æ –±—ã–ª–æ**: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 30 —Å–µ–∫—É–Ω–¥ = 100% –¥–ª—è –≤—Å–µ—Ö YouTube –≤–∏–¥–µ–æ
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –£–º–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (Shorts=60—Å, –æ–±—ã—á–Ω—ã–µ=5–º–∏–Ω, –ø–ª–µ–π–ª–∏—Å—Ç—ã=10–º–∏–Ω)

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫**
- **–ß—Ç–æ –±—ã–ª–æ**: –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ `duration`, `currentTime` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å fallback –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 4: –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏**
- **–ß—Ç–æ –±—ã–ª–æ**: –í–∏–¥–µ–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å –ø—Ä–∏ unmount –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω `useEffect` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏

## ‚úÖ **–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

### üéØ **1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∏–¥–µ–æ**
```typescript
const safeCloseVideo = async (videoId: string) => {
  const currentVideo = videosData.find(v => v.id === videoId);
  if (currentVideo && videoStartTime) {
    try {
      const watchedPercentage = await calculateWatchedPercentage(videoId);
      trackVideoStop(currentVideo, watchedPercentage);
    } catch (error) {
      // Fallback: —Ç—Ä–µ–∫–∞–µ–º —Å 0% –ø—Ä–∏ –æ—à–∏–±–∫–µ
      trackVideoStop(currentVideo, 0);
    }
  }
  setPlayingVideo(null);
};
```

### üìä **2. –¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞**

#### **–î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ:**
```typescript
// –¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ currentTime/duration
const currentTime = videoElement.currentTime || 0;
const duration = videoElement.duration;

if (duration && duration > 0 && !isNaN(duration) && isFinite(duration)) {
  return Math.min((currentTime / duration) * 100, 100);
}

// Fallback: –æ—Ü–µ–Ω–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
const estimatedDuration = videoDurations[videoId] || 300;
return Math.min((watchTime / 1000 / estimatedDuration) * 100, 100);
```

#### **–î–ª—è YouTube –≤–∏–¥–µ–æ:**
```typescript
// –£–º–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ URL
const getYouTubeDuration = async (videoUrl: string): Promise<number> => {
  if (videoUrl.includes('shorts')) return 60;      // Shorts
  if (videoUrl.includes('playlist')) return 600;   // –ü–ª–µ–π–ª–∏—Å—Ç—ã  
  return 300; // –û–±—ã—á–Ω—ã–µ –≤–∏–¥–µ–æ - 5 –º–∏–Ω—É—Ç
};

// –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
const percentage = Math.min((watchTime / 1000 / estimatedDuration) * 100, 100);
```

### üìà **3. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ**
```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
el.addEventListener('loadedmetadata', () => {
  if (el.duration && !isNaN(el.duration) && isFinite(el.duration)) {
    setVideoDurations(prev => ({
      ...prev,
      [video.id]: el.duration
    }));
  }
});

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
el.addEventListener('play', () => {
  setVideoStartPositions(prev => ({
    ...prev,
    [video.id]: el.currentTime
  }));
});
```

### üîÑ **4. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥**

#### **–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Ç–µ–ø–µ—Ä—å —Ç—Ä–µ–∫–∞—é—Ç—Å—è:**
- ‚úÖ –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∏–¥–µ–æ (–∫–Ω–æ–ø–∫–∞ X)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (—Å–∫—Ä–æ–ª–ª –∏–∑ –∑–æ–Ω—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏)
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤
- ‚úÖ –°–º–µ–Ω–∞ –≤–∏–¥–µ–æ
- ‚úÖ Unmount –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

#### **–ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è:**
```typescript
// –ü—Ä–∏ –∫–∞–∂–¥–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
{
  event: 'video_stop',
  videoId: 'video-001',
  watchTime: 45000,        // —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≤ –º—Å
  watchedPercentage: 67,   // —Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç
  stopReason: 'manual' | 'auto' | 'switch' | 'unmount'
}
```

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

### **–î–æ —É–ª—É—á—à–µ–Ω–∏–π:**
- ‚ùå YouTube: –≤—Å–µ–≥–¥–∞ –Ω–µ—Ç–æ—á–Ω–æ (30—Å = 100%)
- ‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–µ: –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚ùå –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Ä—è–ª–∞—Å—å
- ‚ùå –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏

### **–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:**
- ‚úÖ YouTube: —É–º–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Ç–∏–ø—É (60—Å-600—Å)
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ: —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç + fallback
- ‚úÖ –í—Å—ë —Ç—Ä–µ–∫–∞–µ—Ç—Å—è: 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –ü–∞–º—è—Ç—å: –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ unmount

## üéØ **–¢–æ—á–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:**

### **YouTube –≤–∏–¥–µ–æ:**
```
Shorts (60—Å):     95-100% —Ç–æ—á–Ω–æ—Å—Ç—å
–û–±—ã—á–Ω—ã–µ (300—Å):   80-90% —Ç–æ—á–Ω–æ—Å—Ç—å  
–ü–ª–µ–π–ª–∏—Å—Ç—ã (600—Å): 70-85% —Ç–æ—á–Ω–æ—Å—Ç—å
```

### **–õ–æ–∫–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ:**
```
–° –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:    99-100% —Ç–æ—á–Ω–æ—Å—Ç—å
–ë–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:   85-95% —Ç–æ—á–Ω–æ—Å—Ç—å
```

### **–û–±—â–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- ‚úÖ **0% –ø–æ—Ç–µ—Ä—å**: –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Ç—Ä–µ–∫–∞—é—Ç—Å—è
- ‚úÖ **Fallback**: –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è 0%
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Performance**: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

## üöÄ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

1. **üìà –¢–æ—á–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** - —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
2. **üîí –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π  
3. **‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
4. **üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ error handling
5. **üì± –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

## üîß **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**

### **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≤–∏–¥–µ–æ:**
```typescript
// –í getYouTubeDuration –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
if (videoUrl.includes('live')) {
  return 3600; // –°—Ç—Ä–∏–º—ã - 1 —á–∞—Å
}
```

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏:**
```typescript
// –í calculateWatchedPercentage –∏–∑–º–µ–Ω–∏—Ç—å threshold
return Math.min((currentTime / duration) * 100, 100);
```

### **–û—Ç–ª–∞–¥–∫–∞:**
```typescript
// –õ–æ–≥–∏ –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
console.warn('Error calculating watch percentage:', error);
```

**–¢–µ–ø–µ—Ä—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∏–¥–µ–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ! üéâ** 